Phase 1 Inventory System - Documentation
Overview
Complete inventory management system for products and services with tax configuration support. Built for El Salvador DTE (electronic invoice) compliance with full audit trail capability.
System Architecture
Database Schema
Tables:

inventory_items - Core product/service catalog
inventory_item_taxes - Tax associations per item
client_pricing - Client-specific pricing (future use)

Key Design Decisions:

SKU and barcode optional at API level, auto-generated by backend
Tax-exclusive pricing (taxes calculated at invoice time)
Soft deletes (active flag) for data retention
Company isolation via company_id foreign key

Application Layer
File Structure:
internal/
├── models/
│   ├── inventory_item.go      # Item models and validation
│   └── inventory_tax.go        # Tax models and validation
├── services/
│   └── inventory_service.go    # Business logic
└── handlers/
    └── inventory.go            # HTTP endpoints
API Endpoints
Item Management
Create Item
POST /v1/inventory/items
Headers: X-Company-ID: <uuid>
Body: {
  "tipo_item": "1|2",           // 1=Bienes, 2=Servicios
  "sku": "OPTIONAL",            // Auto-generated if omitted
  "codigo_barras": "OPTIONAL",  // Auto-generated for tipo_item=1
  "name": "required",
  "description": "optional",
  "manufacturer": "optional",
  "image_url": "optional",
  "cost_price": 0.00,           // Optional
  "unit_price": 0.00,           // Required
  "unit_of_measure": "unidad",  // Required (whitelist enforced)
  "color": "optional",
  "taxes": []                   // Optional, defaults to IVA 13%
}

Response: 201 Created
{
  "id": "uuid",
  "sku": "PROD-20251003-5191",  // Auto-generated
  "codigo_barras": "2043848716407", // Auto-generated
  "taxes": [
    {
      "tributo_code": "S1.20",  // Default IVA 13%
      ...
    }
  ],
  ...
}
Get Item
GET /v1/inventory/items/:id
Headers: X-Company-ID: <uuid>

Response: 200 OK
{
  "id": "uuid",
  "sku": "...",
  "taxes": [...],
  ...
}
List Items
GET /v1/inventory/items?active=true&tipo_item=1
Headers: X-Company-ID: <uuid>

Query Parameters:
- active: true|false (default: true)
- tipo_item: 1|2 (optional filter)

Response: 200 OK
{
  "items": [...],
  "count": 5
}
Update Item
PUT /v1/inventory/items/:id
Headers: X-Company-ID: <uuid>
Body: {
  "name": "optional",
  "unit_price": 0.00,
  // All fields optional
}

Response: 200 OK
{...updated item...}
Delete Item (Soft)
DELETE /v1/inventory/items/:id
Headers: X-Company-ID: <uuid>

Response: 200 OK
{
  "message": "item deleted successfully"
}
Tax Management
List Item Taxes
GET /v1/inventory/items/:id/taxes
Headers: X-Company-ID: <uuid>

Response: 200 OK
{
  "taxes": [
    {
      "tributo_code": "S1.20",
      "created_at": "..."
    }
  ],
  "count": 1
}
Add Tax to Item
POST /v1/inventory/items/:id/taxes
Headers: X-Company-ID: <uuid>
Body: {
  "tributo_code": "S3.A7"
}

Response: 201 Created
{
  "id": "uuid",
  "tributo_code": "S3.A7",
  ...
}
Remove Tax from Item
DELETE /v1/inventory/items/:id/taxes/:code
Headers: X-Company-ID: <uuid>

Response: 200 OK
{
  "message": "tax removed successfully"
}
Validation Rules
Item Validation

tipo_item: Must be "1" or "2"
sku: 3-50 alphanumeric with dashes, uppercase enforced
unit_of_measure: Must be in whitelist (unidad, servicio, hora, kilogramo, gramo, litro, mililitro, metro, centimetro, caja)
unit_price: Cannot be negative
cost_price: Cannot be negative
Services (tipo_item=2) cannot have barcodes

Tax Validation

tributo_code: Must exist in codigos.Tributos map
No duplicate taxes per item (enforced at database level)

Auto-Generation Logic
SKU Generation
Format: PREFIX-YYYYMMDD-XXXX

Products: PROD-20251003-1234
Services: SRV-20251003-1234
Uses cryptographically secure random numbers
Checks for uniqueness within company (10 attempts)

Barcode Generation
Format: 20XXXXXXXXXXX (13 digits)

Only for products (tipo_item=1)
Starts with "20" (internal use designation)
EAN-13 compatible format
Uses cryptographically secure random numbers

Default Tax Assignment
If no taxes provided in request:

tipo_item=1 (Bienes): Assigns S1.20 (IVA 13%)
tipo_item=2 (Servicios): Assigns S1.20 (IVA 13%)

Additional taxes can be added manually after creation.
Error Codes
CodeHTTP StatusMeaningvalidation_failed400Request validation errorinvalid_json400Malformed JSONduplicate_sku409SKU already existsduplicate_barcode409Barcode already existsduplicate_tax409Tax already assignednot_found404Item/tax not foundinternal_error500Server error
Testing
Test Script: test_inventory.sh
Tests:

Product with auto-generated SKU/barcode
Product with custom SKU
Service with auto-generated SKU
Service with custom SKU
Beer with multiple taxes (IVA + alcohol tax)
List all items
Filter by tipo_item
Get item taxes
Error cases (invalid inputs, duplicates)

Run:
bash./test_inventory.sh <company_id>
Future Phases
Phase 2: Transaction/Invoice Layer

Invoice tables with complete snapshots
Capture price, tax rate, and amounts at transaction time
Immutable transaction log
DTE generation
Stock deduction (calls inventory service)

Phase 3: Reporting & Audit

Export transactions by date range
Excel/CSV downloads
Tax summaries
Audit-friendly reports

Phase 4: Stock Tracking

inventory_transactions table
Purchase/sale/adjustment recording
Real-time stock levels
Low stock alerts

Design Principles

Immutability for Audit - Transaction data never changes
Snapshot Strategy - Capture full state at transaction time
Tax-Exclusive Pricing - Taxes calculated at invoice time
Company Isolation - All queries scoped to company_id
Auto-Generation - Reduce manual data entry errors
Soft Deletes - Preserve data for audit trail

Tax Code Reference
S1.XX - General consumption taxes

S1.20 = IVA 13% (standard VAT)

S3.XX - Specific excise taxes

S3.A7 = Alcohol tax
Applied in addition to S1 taxes

Database Constraints

Unique constraint: (company_id, sku)
Unique constraint: (company_id, codigo_barras)
Unique constraint: (item_id, tributo_code)
Foreign key: company_id → companies.id
Check constraint: tipo_item IN ('1', '2')
Check constraint: unit_price >= 0


Status: Phase 1 Complete
Last Updated: October 3, 2025
Next Phase: Transaction/Invoice Layer Design
